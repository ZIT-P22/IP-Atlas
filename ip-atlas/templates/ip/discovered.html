{% extends "layout.html" %}
{% block content %}
<div class="container mx-auto mt-10">
    <h1 class="text-2xl font-semibold mb-6">Gefundene Ger√§te</h1>

    <div class="flex justify-end">
        <button id="start-scan" class="mb-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Scan jetzt starten</button>
    </div>

    <div id="progress-bar" class="hidden mb-4">
        <div class="w-full bg-gray-200 rounded-full">
            <div id="progress" class="bg-blue-500 text-xs leading-none py-1 text-center text-white rounded-full" style="width: 0%">0%</div>
        </div>
    </div>

    <div id="results" class="mt-6">
        <table class="min-w-full bg-white">
            <thead>
                <tr>
                    <th class="py-2">MAC-Adresse</th>
                    <th class="py-2">IPv4</th>
                    <th class="py-2">IPv6</th>
                    <th class="py-2">Hostname</th>
                    <th class="py-2">Vendor</th>
                    <th class="py-2">Tags</th>
                </tr>
            </thead>
            <tbody id="device-list" class="text-gray-700">
                {% for device in devices %}
                <tr>
                    <td class="py-2">{{ device.mac_address }}</td>
                    <td class="py-2">{{ device.ipv4 }}</td>
                    <td class="py-2">{{ device.ipv6 }}</td>
                    <td class="py-2">{{ device.hostname }}</td>
                    <td class="py-2">{{ device.vendor }}</td>
                    <td class="py-2">{{ device.tags }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .hidden {
        display: none;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const startScanButton = document.getElementById('start-scan');
        const progressBar = document.getElementById('progress-bar');
        const progressElement = document.getElementById('progress');
        const deviceList = document.getElementById('device-list');

        startScanButton.addEventListener('click', function() {
            progressBar.classList.remove('hidden');
            startScanButton.disabled = true;

            fetch('{{ url_for("scan.start_scan") }}', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'scan_started') {
                        updateProgress();
                    }
                });
        });

        function updateProgress() {
            fetch('{{ url_for("scan.scan_progress") }}')
                .then(response => response.json())
                .then(data => {
                    const percentage = (data.completed / data.total) * 100;
                    progressElement.style.width = percentage + '%';
                    progressElement.textContent = Math.round(percentage) + '%';

                    if (data.status === 'scanning') {
                        setTimeout(updateProgress, 1000);
                    } else {
                        fetchResults();
                        startScanButton.disabled = false;
                    }
                });
        }

        function fetchResults() {
            fetch('{{ url_for("scan.get_results") }}')
                .then(response => response.json())
                .then(data => {
                    deviceList.innerHTML = '';
                    data.devices.forEach(device => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="py-2">${device.mac_address}</td>
                            <td class="py-2">${device.ipv4}</td>
                            <td class="py-2">${device.ipv6}</td>
                            <td class="py-2">${device.hostname}</td>
                            <td class="py-2">${device.vendor}</td>
                            <td class="py-2">${device.tags.join(', ')}</td>
                        `;
                        deviceList.appendChild(row);
                    });
                    progressBar.classList.add('hidden');
                });
        }
    });
</script>
{% endblock %}
